// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =============================================
// ENUMS
// =============================================

enum UserType {
  gym_owner
  staff
  member
  super_admin
}

enum UserStatus {
  active
  inactive
  suspended
  pending
}

enum MembershipStatus {
  active
  expired
  suspended
  cancelled
}

enum CheckinStatus {
  checked_in
  checked_out
}

enum StaffStatus {
  active
  inactive
  terminated
}

enum DayOfWeek {
  monday
  tuesday
  wednesday
  thursday
  friday
  saturday
  sunday
}

enum ScheduleStatus {
  scheduled
  off
  sick
  vacation
}

enum Trend {
  up
  down
  stable
}

enum ProductCategory {
  membership
  class
  service
  supplement
  equipment
}

enum ProductStatus {
  active
  inactive
}

enum ClassStatus {
  active
  cancelled
  completed
}

enum BookingStatus {
  booked
  waitlist
  cancelled
  attended
  no_show
}

enum PaymentType {
  membership
  class
  service
  product
  penalty
}

enum PaymentMethod {
  cash
  card
  transfer
  qris
  wallet
}

enum PaymentStatus {
  pending
  completed
  failed
  refunded
}

enum BillStatus {
  pending
  paid
  overdue
  cancelled
}

enum WalletType {
  qris
  bank_transfer
  cash
  card
}

enum TransactionType {
  income
  withdrawal
  adjustment
  fee
}

enum ReferenceType {
  payment
  pos_transaction
  manual_adjustment
  withdrawal_request
}

enum PosStatus {
  pending
  completed
  cancelled
  refunded
}

enum DiscountType {
  percentage
  fixed_amount
  buy_one_get_one
}

enum GymStatus {
  active
  inactive
}

// =============================================
// MODELS
// =============================================

model User {
  id               String     @id @default(uuid())
  email            String?    @unique
  passwordHash     String?    @map("password_hash")
  name             String
  phone            String?    @unique
  pinHash          String?    @map("pin_hash")
  avatar           String?
  userType         UserType   @map("user_type")
  status           UserStatus @default(active)
  emailVerified    Boolean    @default(false) @map("email_verified")
  phoneVerified    Boolean    @default(false) @map("phone_verified")
  emergencyContact Json?      @map("emergency_contact")
  profileImage     String?    @map("profile_image")
  pinAttempts      Int        @default(0) @map("pin_attempts")
  pinLockedUntil   DateTime?  @map("pin_locked_until")
  lastPinChange    DateTime?  @map("last_pin_change")
  phoneOtp         String?    @map("phone_otp")
  phoneOtpExpires  DateTime?  @map("phone_otp_expires")
  phoneOtpAttempts Int        @default(0) @map("phone_otp_attempts")

  lastLogin DateTime? @map("last_login")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  ownedGyms    Gym[]         @relation("GymOwner")
  member       Member[]
  staff        Staff?
  sessions     UserSession[]
  activityLogs ActivityLog[]

  @@map("users")
}

model Gym {
  id          String    @id @default(uuid())
  ownerId     String    @map("owner_id")
  name        String
  address     String?
  phone       String?
  email       String?
  description String?
  logo        String?
  code        String?   @unique @db.VarChar(4)
  settings    Json?
  status      GymStatus @default(active)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  owner           User             @relation("GymOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members         Member[]
  staff           Staff[]
  products        Product[]
  classes         Class[]
  payments        Payment[]
  bills           Bill[]
  wallets         Wallet[]
  posTransactions PosTransaction[]
  discounts       Discount[]
  checkInRecords  CheckInRecord[]
  activityLogs    ActivityLog[]

  @@map("gyms")
}

model Member {
  id               String           @id @default(uuid())
  userId           String           @map("user_id")
  gymId            String           @map("gym_id")
  memberCode       String?          @unique @map("member_code")
  membershipType   String?          @map("membership_type")
  membershipStatus MembershipStatus @default(active) @map("membership_status")
  joinDate         DateTime?        @map("join_date") @db.Date
  membershipExpiry DateTime?        @map("membership_expiry") @db.Date
  totalVisits      Int              @default(0) @map("total_visits")
  qrCode           String?          @map("qr_code")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  // Relations
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  gym             Gym              @relation(fields: [gymId], references: [id], onDelete: Cascade)
  checkInRecords  CheckInRecord[]
  classBookings   ClassBooking[]
  payments        Payment[]
  bills           Bill[]
  posTransactions PosTransaction[]

  @@map("members")
}

model CheckInRecord {
  id           String        @id @default(uuid())
  memberId     String        @map("member_id")
  gymId        String        @map("gym_id")
  checkInTime  DateTime?     @map("check_in_time")
  checkOutTime DateTime?     @map("check_out_time")
  status       CheckinStatus @default(checked_in)
  createdAt    DateTime      @default(now()) @map("created_at")

  // Relations
  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
  gym    Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)

  @@map("check_in_records")
}

model Staff {
  id               String      @id @default(uuid())
  userId           String      @unique @map("user_id")
  gymId            String      @map("gym_id")
  employeeId       String?     @unique @map("employee_id")
  role             String?
  department       String?
  hireDate         DateTime?   @map("hire_date") @db.Date
  salary           Decimal?    @db.Decimal(10, 2)
  address          String?
  emergencyContact Json?       @map("emergency_contact")
  certifications   Json?
  goals            Json?
  status           StaffStatus @default(active)
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")

  // Relations
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  gym             Gym                @relation(fields: [gymId], references: [id], onDelete: Cascade)
  schedules       StaffSchedule[]
  performance     StaffPerformance[]
  classes         Class[]
  posTransactions PosTransaction[]

  @@map("staff")
}

model StaffSchedule {
  id        String         @id @default(uuid())
  staffId   String         @map("staff_id")
  dayOfWeek DayOfWeek?     @map("day_of_week")
  startTime DateTime?      @map("start_time") @db.Time
  endTime   DateTime?      @map("end_time") @db.Time
  status    ScheduleStatus @default(scheduled)
  createdAt DateTime       @default(now()) @map("created_at")

  // Relations
  staff Staff @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@map("staff_schedules")
}

model StaffPerformance {
  id                 String   @id @default(uuid())
  staffId            String   @map("staff_id")
  rating             Decimal? @db.Decimal(3, 2)
  classesLed         Int      @default(0) @map("classes_led")
  memberSatisfaction Decimal? @map("member_satisfaction") @db.Decimal(3, 2)
  attendanceRate     Decimal? @map("attendance_rate") @db.Decimal(5, 2)
  monthYear          String?  @map("month_year")
  trend              Trend    @default(stable)
  createdAt          DateTime @default(now()) @map("created_at")

  // Relations
  staff Staff @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@map("staff_performance")
}

model Product {
  id          String          @id @default(uuid())
  gymId       String          @map("gym_id")
  name        String
  description String?
  price       Decimal         @db.Decimal(10, 2)
  category    ProductCategory
  duration    Int?
  capacity    Int?
  features    Json?
  status      ProductStatus   @default(active)
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  // Relations
  gym                 Gym                  @relation(fields: [gymId], references: [id], onDelete: Cascade)
  classes             Class[]
  posTransactionItems PosTransactionItem[]

  @@map("products")
}

model Class {
  id           String      @id @default(uuid())
  gymId        String      @map("gym_id")
  productId    String?     @map("product_id")
  name         String
  instructorId String?     @map("instructor_id")
  type         String?
  scheduleDay  DayOfWeek?  @map("schedule_day")
  scheduleTime DateTime?   @map("schedule_time") @db.Time
  duration     Int?
  capacity     Int?
  booked       Int         @default(0)
  waitlist     Int         @default(0)
  room         String?
  price        Decimal?    @db.Decimal(10, 2)
  status       ClassStatus @default(active)
  date         DateTime?   @db.Date
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  // Relations
  gym        Gym            @relation(fields: [gymId], references: [id], onDelete: Cascade)
  product    Product?       @relation(fields: [productId], references: [id], onDelete: SetNull)
  instructor Staff?         @relation(fields: [instructorId], references: [id], onDelete: SetNull)
  bookings   ClassBooking[]

  @@map("classes")
}

model ClassBooking {
  id            String        @id @default(uuid())
  classId       String        @map("class_id")
  memberId      String        @map("member_id")
  bookingStatus BookingStatus @default(booked) @map("booking_status")
  bookingDate   DateTime      @default(now()) @map("booking_date")
  attendedAt    DateTime?     @map("attended_at")

  // Relations
  class  Class  @relation(fields: [classId], references: [id], onDelete: Cascade)
  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("class_bookings")
}

model Payment {
  id            String        @id @default(uuid())
  gymId         String        @map("gym_id")
  memberId      String?       @map("member_id")
  amount        Decimal       @db.Decimal(10, 2)
  type          PaymentType
  method        PaymentMethod
  status        PaymentStatus @default(pending)
  transactionId String?       @map("transaction_id")
  referenceId   String?       @map("reference_id")
  description   String?
  processedAt   DateTime?     @map("processed_at")
  createdAt     DateTime      @default(now()) @map("created_at")

  // Relations
  gym    Gym     @relation(fields: [gymId], references: [id], onDelete: Cascade)
  member Member? @relation(fields: [memberId], references: [id], onDelete: SetNull)

  @@map("payments")
}

model Bill {
  id             String     @id @default(uuid())
  gymId          String     @map("gym_id")
  memberId       String     @map("member_id")
  membershipType String?    @map("membership_type")
  amount         Decimal    @db.Decimal(10, 2)
  dueDate        DateTime   @map("due_date") @db.Date
  status         BillStatus @default(pending)
  autoPayEnabled Boolean    @default(false) @map("auto_pay_enabled")
  createdAt      DateTime   @default(now()) @map("created_at")
  paidAt         DateTime?  @map("paid_at")

  // Relations
  gym    Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)
  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("bills")
}

model Wallet {
  id               String     @id @default(uuid())
  gymId            String     @map("gym_id")
  walletType       WalletType @map("wallet_type")
  currentBalance   Decimal    @default(0.00) @map("current_balance") @db.Decimal(12, 2)
  initialBalance   Decimal    @default(0.00) @map("initial_balance") @db.Decimal(12, 2)
  totalIncome      Decimal    @default(0.00) @map("total_income") @db.Decimal(12, 2)
  totalWithdrawals Decimal    @default(0.00) @map("total_withdrawals") @db.Decimal(12, 2)
  totalFees        Decimal    @default(0.00) @map("total_fees") @db.Decimal(12, 2)
  todayIncome      Decimal    @default(0.00) @map("today_income") @db.Decimal(12, 2)
  isActive         Boolean    @default(true) @map("is_active")
  canWithdraw      Boolean    @default(true) @map("can_withdraw")
  minWithdrawal    Decimal    @default(0.00) @map("min_withdrawal") @db.Decimal(10, 2)
  createdAt        DateTime   @default(now()) @map("created_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")

  // Relations
  gym          Gym                 @relation(fields: [gymId], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]

  @@map("wallets")
}

model WalletTransaction {
  id              String          @id @default(uuid())
  walletId        String          @map("wallet_id")
  transactionType TransactionType @map("transaction_type")
  amount          Decimal         @db.Decimal(12, 2)
  feeAmount       Decimal         @default(0.00) @map("fee_amount") @db.Decimal(12, 2)
  netAmount       Decimal         @map("net_amount") @db.Decimal(12, 2)
  description     String?
  referenceType   ReferenceType?  @map("reference_type")
  referenceId     String?         @map("reference_id")
  processedAt     DateTime        @default(now()) @map("processed_at")

  // Relations
  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@map("wallet_transactions")
}

model PosTransaction {
  id             String        @id @default(uuid())
  gymId          String        @map("gym_id")
  memberId       String?       @map("member_id")
  staffId        String?       @map("staff_id")
  subtotal       Decimal       @db.Decimal(10, 2)
  tax            Decimal       @default(0.00) @db.Decimal(10, 2)
  discountAmount Decimal       @default(0.00) @map("discount_amount") @db.Decimal(10, 2)
  total          Decimal       @db.Decimal(10, 2)
  paymentMethod  PaymentMethod @map("payment_method")
  status         PosStatus     @default(completed)
  discountCode   String?       @map("discount_code")
  referralCode   String?       @map("referral_code")
  referralReward Decimal       @default(0.00) @map("referral_reward") @db.Decimal(10, 2)
  timestamp      DateTime      @default(now())

  // Relations
  gym        Gym                  @relation(fields: [gymId], references: [id], onDelete: Cascade)
  member     Member?              @relation(fields: [memberId], references: [id], onDelete: SetNull)
  staff      Staff?               @relation(fields: [staffId], references: [id], onDelete: SetNull)
  items      PosTransactionItem[]
  gymInvoice GymInvoice[]

  @@map("pos_transactions")
}

model PosTransactionItem {
  id            String    @id @default(uuid())
  transactionId String    @map("transaction_id")
  productId     String?   @map("product_id")
  name          String
  price         Decimal   @db.Decimal(10, 2)
  quantity      Int
  category      String?
  subtotal      Decimal   @db.Decimal(10, 2)
  startDate     DateTime? @map("start_date") @db.Date
  endDate       DateTime? @map("end_date") @db.Date

  // Relations
  transaction PosTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  product     Product?       @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([startDate, endDate])
  @@map("pos_transaction_items")
}

model Discount {
  id                 String       @id @default(uuid())
  gymId              String       @map("gym_id")
  code               String       @unique
  name               String
  description        String?
  type               DiscountType
  value              Decimal      @db.Decimal(10, 2)
  minPurchase        Decimal      @default(0.00) @map("min_purchase") @db.Decimal(10, 2)
  maxDiscount        Decimal?     @map("max_discount") @db.Decimal(10, 2)
  validFrom          DateTime?    @map("valid_from") @db.Date
  validUntil         DateTime?    @map("valid_until") @db.Date
  usageLimit         Int?
  usedCount          Int          @default(0) @map("used_count")
  isActive           Boolean      @default(true) @map("is_active")
  memberTiers        Json?        @map("member_tiers")
  applicableProducts Json?        @map("applicable_products")
  conditions         Json?
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")

  // Relations
  gym Gym @relation(fields: [gymId], references: [id], onDelete: Cascade)

  @@map("discounts")
}

model UserSession {
  id               String    @id @default(uuid())
  userId           String    @map("user_id")
  sessionToken     String    @unique @map("session_token")
  refreshToken     String?   @unique @map("refresh_token")
  deviceInfo       Json?     @map("device_info")
  ipAddress        String?   @map("ip_address")
  userAgent        String?   @map("user_agent")
  expiresAt        DateTime  @map("expires_at")
  refreshExpiresAt DateTime? @map("refresh_expires_at")
  isActive         Boolean   @default(true) @map("is_active")
  lastActivity     DateTime  @default(now()) @map("last_activity")
  createdAt        DateTime  @default(now()) @map("created_at")

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  activityLogs ActivityLog[]

  @@map("user_sessions")
}

model OtpVerification {
  id        String   @id @default(uuid())
  phone     String
  otpCode   String   @map("otp_code")
  purpose   String
  attempts  Int      @default(0)
  verified  Boolean  @default(false)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("otp_verifications")
}

model ActivityLog {
  id         String   @id @default(uuid())
  gymId      String?  @map("gym_id")
  userId     String?  @map("user_id")
  sessionId  String?  @map("session_id")
  action     String
  entityType String?  @map("entity_type")
  entityId   String?  @map("entity_id")
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  gym     Gym?         @relation(fields: [gymId], references: [id], onDelete: SetNull)
  user    User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  session UserSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@map("activity_logs")
}

model GymInvoice {
  id              String   @id @default(uuid())
  gymId           String   @map("gym_id")
  transactionId   String?
  transactionDate DateTime @map("transaction_date") @db.Date
  fee             Int
  year            Int
  month           Int
  createdAt       DateTime @default(now()) @map("created_at")

  posTransaction PosTransaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)

}
